{{extend 'layout.html'}}
{{block head}}
<style>
  .inclusions {
    background-color: Green;
    color: white;
  }

  .badge {
    magin-left: 2px;
  }
  .badge-inclusions {
    background-color: Green;
    color: White;
  }

  .addCode {
    background-color: Blue;
    color: White;
  }

  .badge-addCode {
    background-color: Blue;
    color: White;
  }

  .codeFirst {
    background-color: Aquamarine;
    color: Grey;
  }

  .badge-codeFirst {
    background-color: Aquamarine;
    color: Grey;
  }
  .exclusions1 {
    background-color: Red;
    color: white;
  }

  .badge-exclusions1 {
    background-color: Red;
    color: White;
  }

  .exclusions2 {
    background-color: Orange;
    color: white;
  }

  .badge-exclusions2 {
    background-color: Orange;
    color: White;
  }

  .sevenChrNote , .sevenChrDef {
    background-color: Beige;
    color: Grey;
  }

  .badge-sevenChrNote {
    background-color: Beige;
    color: Grey;
  }

  .subdiag {
    background-color: LightBlue;
    color: black;
    margin-left: 20px;
  }
  .specify {
    background-color: Ivory;
    color: black;
    margin-left: 10px;
  }

  .code {
    background-color: Crimson;
    color: White;
  }

  ol {
    list-style-type: decimal;
  }

  .results {
    margin-top: 5px;
  }
</style>
{{end}}

<div class="row">
  <div class="container-fluid">
    <div class="col-md-4">
      <form id="index">
        <div class="input-group">
          <input type="text" class="form-control desc" placeholder="icd-10 index search"></input>
          <span class="input-group-btn"><button class="btn btn-primary submit" type="button">search</button></span>
        </div>
      </form>
    </div>
    <div class="col-md-8">
      <form id="icd10">
        <div class="input-group">
          <input type="text" class="form-control desc" placeholder="icd-10 tab search"></input>
          <span class="input-group-btn"><button class="btn btn-primary submit" type="button">search</button></span>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row results">
  <div class="container-fluid">
    <div class="col-md-4">
      <div id="icd10index" class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">ICD-10 Index</h3>
        </div>
        <div id="index" class="panel-body">
        </div>
        <div class="panel-footer">
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div id="icd10tab" class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">ICD-10 Codes</h3>
        </div>
        <div id="tabular" class="panel-body">
        </div>
        <div class="panel-footer">
        </div>
      </div>
    </div>
  </div>
</div>



<script type="text/javascript">

items_list = { 'items': [
  {'item': 'codeFirst', 'children1':'codeFirst', 'children2':'note','span_class': 'codeFirst', 'txt':'Code1st', 'txt_long':'Code first'},
  {'item': 'addCode', 'children1':'useAdditionalCode', 'children2':'note','span_class': 'addCode', 'txt':'Code+', 'txt_long':'Use additionnal code'},
  {'item': 'inclusions', 'children1':'inclusionTerm', 'children2':'note','span_class': 'inclusions', 'txt':'Inc', 'txt_long':'Inclusions'},
  {'item': 'exclusions1', 'children1':'excludes1', 'children2':'note','span_class': 'exclusions1', 'txt':'X1', 'txt_long':'Exclusions 1'},
  {'item': 'exclusions2', 'children1':'excludes2', 'children2':'note','span_class': 'exclusions2', 'txt':'X2', 'txt_long':'Exclusions 2'},
  {'item': 'sevenChrNote', 'children1':'sevenChrNote', 'children2':'note','span_class': '', 'txt':'', 'txt_long':'Use 7th char'},
  {'item': 'sevenChrDef', 'children1':'sevenChrDef', 'children2':'extension','span_class': 'sevenChrNote', 'txt':'7th', 'txt_long':''}
]};

$('#icd10 .submit').click(function(e){
  e.preventDefault();
  search_str= $('#icd10 input.desc').val();
  console.log(search_str);
  get_diag(search_str);
})

function get_diag(search_str) {
  var API_URL = '{{=URL('api','icd10.xml', scheme=True, host=True)}}?search='+search_str;
  $.ajax({
    url: API_URL,
    type: 'GET',
    dataType: 'xml',
    contentType: 'application/xml',
    success: function (data) {
      html = ['<ol>'];
      $(data).children('main').children('diag').children('desc').each(function() {
        html.push('<li>'+'<div class="main_diag">'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span></div>');
        $subdiag = $(this).parent().children('diag').children('desc');
        if ($subdiag.length > 0) {
          html.push('<span class="badge badge-subdiag">Subdiag</span>');
        };
        loop_items('main', $(this));
        if ($subdiag.length > 0) {
          html.push('<div class="subdiag"><ul>');
          $subdiag.each(function() {
            html.push('<li>'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span>');
            $specify = $(this).parent().children('diag').children('desc');
            if ($specify.length > 0) {
              html.push('<span class="badge badge-specify">Specify</span>');
            };
            loop_items('secondary', $(this));
            if ($specify.length > 0) {
              html.push('<div class="specify"><ul>');
              $specify.each(function() {
                html.push('<li>'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span>');
                $specify2 = $(this).parent().children('diag').children('desc');
                if ($specify2.length > 0) {
                  html.push('<span class="badge badge-specify">Specify</span>');
                }
                loop_items('secondary', $(this));
                if ($specify2.length > 0) {
                  html.push('<div class="specify2"><ul>');
                  $specify2.each(function() {
                    html.push('<li>'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span>');
                    loop_items('secondary', $(this));
                    html.push('</li>'); // li specify2
                  });
                  html.push('</ul>'); // ul specify2
                };
                html.push('</li>'); // li specify
              });
              html.push('</ul></div>'); // div specify
            }
            html.push('</li>') // li subdiag
          });
          html.push('</ul></div>'); // div subdiag
        }
        html.push('</li></div>'); // div main_diag_content
      });
      html.push('</ol>');
      var final_result = html.join('');
      var regex = /[A-Z]\d\d\.?[0-9X]?[0-9X]?[0-9X]?[A-Z]?/g;
      final_result = final_result.replace(regex,'<icd10>$&</icd10>');
      $('div#tabular').html(final_result);
      toggle_items('specify','subdiag');
      toggle_items('specify2','specify');
      $('div.main_diag_content').hide();
      $('div.main_diag').click(function(){
        $(this).parent().children('div.main_diag_content').toggle();
      });
      code_click('icd10');
    },
    error: function () {
      console.log('error getting exams');
      }
  });
  }

$(function() {
    $("body").tooltip({ selector: '[data-toggle=tooltip]' });
}); // document ready

function loop_items(level, $loc) {
  $.each(items_list.items, function(index, el) {
    if (el.item == 'sevenChrNote') {
      // do nothing
    } else {
      $item = $loc.parent().children(el.children1).children(el.children2);
      if ($item.length >0) {
        html.push('<span class="badge badge-'+el.span_class+'">'+el.txt+'</span>');
      };
    };
  });
  if (level == 'main') {
    html.push('<div class="main_diag_content">');
  };
  $.each(items_list.items, function(index, el) {
    if (el.item == 'sevenChrDef'){
      $item = $loc.parent().children(el.children1).children(el.children2);
      if ($item.length > 0) {
        html.push('<div class="sevenChrDef"><ul>');
        $item.each(function( index, el) {
          html.push('<li><span class="code" code7="'+$(this).attr('char')+'">'+$(this).attr('char')+'</span> :<strong>'+$(this).text()+'</strong></li>');
        });
        html.push('</ul></div>');
      };
    } else {
      $item = $loc.parent().children(el.children1).children(el.children2);
      if ($item.length > 0) {
        html.push('<div class="'+el.span_class+'">'+el.txt_long+'<ul>');
        $item.each(function() {
          html.push('<li>'+$(this).text()+'</li>');
        });
        html.push('</ul></div>');
      };
    };
  });
}

function toggle_items(level,uplevel) {
  $('div.'+level).hide();
  $.each(items_list.items, function(index,el){
    $('div.'+uplevel+' > ul > li > div.'+el.item).hide();
  });
  $('div.'+uplevel+' > ul > li').click(function(event) {
    $(this).children('div.'+uplevel+' > ul > li > div.'+level).toggle();
    $loc = $(this);
    $.each(items_list.items, function(index, el) {
      console.log('$loc.children(\'div.'+uplevel+' > ul > li > div.'+el.item+'\').toggle();');
      $loc.children('div.'+uplevel+' > ul > li > div.'+el.item).toggle();
    });
    event.stopPropagation();
  });
}

function code_click(tagName) {
  var DELAY = 200,
    clicks = 0,
    timer = null;
    $(tagName).on("click", function(e){
      search_str= $(this).text();
      clicks++;  //count clicks
      if(clicks === 1) {
        timer = setTimeout(function() {
          alert('simple click:'+search_str);  //perform single-click action
          clicks = 0;             //after action performed, reset counter
          }, DELAY);
      } else {
        clearTimeout(timer);    //prevent single-click action
        $('#icd10 input.desc').val(search_str);
        get_diag(search_str);
        clicks = 0;             //after action performed, reset counter
      };
      e.stopPropagation();
    })
      .on("dblclick", function(e){
          e.preventDefault();  //cancel system double-click event
      });
}
</script>

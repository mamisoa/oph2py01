{{extend 'layout.html'}}
{{block head}}
<style>
  .inclusion {
    background-color: Green;
    color: white;
  }

  .badge {
    magin-left: 2px;
  }
  .badge-inclusions {
    background-color: Green;
    color: White;
  }

  .addCode {
    background-color: Blue;
    color: White;
  }

  .badge-addCode {
    background-color: Blue;
    color: White;
  }

  .codeFirst {
    background-color: Aquamarine;
    color: Grey;
  }

  .badge-codeFirst {
    background-color: Aquamarine;
    color: Grey;
  }
  .exclusions1 {
    background-color: Red;
    color: white;
  }

  .badge-exclusions1 {
    background-color: Red;
    color: White;
  }

  .exclusions2 {
    background-color: Orange;
    color: white;
  }

  .badge-exclusions2 {
    background-color: Orange;
    color: White;
  }

  .sevenChrNote , .sevenChrDef {
    background-color: Beige;
    color: Grey;
  }

  .badge-sevenChrNote {
    background-color: Beige;
    color: Grey;
  }

  .subdiag {
    background-color: LightBlue;
    color: black;
    margin-left: 20px;
  }
  .specify {
    background-color: Ivory;
    color: black;
    margin-left: 10px;
  }

  .code {
    background-color: Crimson;
    color: White;
  }

  ol {
    list-style-type: decimal;
  }

  .results {
    margin-top: 5px;
  }
</style>
{{end}}

<div class="row">
  <div class="container-fluid">
    <div class="col-md-4">
      <form id="index">
        <div class="input-group">
          <input type="text" class="form-control desc" placeholder="icd-10 index search"></input>
          <span class="input-group-btn"><button class="btn btn-primary submit" type="button">search</button></span>
        </div>
      </form>
    </div>
    <div class="col-md-8">
      <form id="icd10">
        <div class="input-group">
          <input type="text" class="form-control desc" placeholder="icd-10 tab search"></input>
          <span class="input-group-btn"><button class="btn btn-primary submit" type="button">search</button></span>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row results">
  <div class="container-fluid">
    <div class="col-md-4">
      <div id="icd10index" class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">ICD-10 Index</h3>
        </div>
        <div id="index" class="panel-body">
        </div>
        <div class="panel-footer">
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div id="icd10tab" class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">ICD-10 Codes</h3>
        </div>
        <div id="tabular" class="panel-body">
        </div>
        <div class="panel-footer">
        </div>
      </div>
    </div>
  </div>
</div>



<script type="text/javascript">

$('#icd10 .submit').click(function(e){
  e.preventDefault();
  search_str= $('#icd10 input.desc').val();
  console.log(search_str);
  get_diag(search_str);
})

function get_diag(search_str) {
  var API_URL = '{{=URL('api','icd10.xml', scheme=True, host=True)}}?search='+search_str;
  $.ajax({
    url: API_URL,
    type: 'GET',
    dataType: 'xml',
    contentType: 'application/xml',
    success: function (data) {
      html = ['<ol>'];
      $(data).children('main').children('diag').children('desc').each(function() {
        html.push('<li>'+'<div class="main_diag">'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span></div>');
        $subdiag = $(this).parent().children('diag').children('desc');
        if ($subdiag.length > 0) {
          html.push('<span class="badge badge-subdiag">Subdiag</span>');
        }
        $codeFirst = $(this).parent().children('codeFirst').children('note');
        if ($codeFirst.length >0) {
          html.push('<span class="badge badge-codeFirst">Code1st</span>');
        }
        $addCode = $(this).parent().children('useAdditionalCode').children('note');
        if ($addCode.length >0) {
          html.push('<span class="badge badge-addCode">Code+</span>');
        }
        $inclusion = $(this).parent().children('inclusionTerm').children('note');
        if ($inclusion.length >0) {
          html.push('<span class="badge badge-inclusions">Inc</span>');
        }
        $exclusions1 = $(this).parent().children('excludes1').children('note');
        if ($exclusions1.length >0) {
          html.push('<span class="badge badge-exclusions1">X1</span>');
        }
        $exclusions2 = $(this).parent().children('excludes2').children('note');
        if ($exclusions2.length >0) {
          html.push('<span class="badge badge-exclusions2">X2</span>');
        }
        $sevenChrNote = $(this).parent().children('sevenChrNote').children('note');
        $sevenChrDef = $(this).parent().children('sevenChrDef').children('extension');
        if ($sevenChrNote.length >0) {
          html.push('<span class="badge badge-sevenChrNote">7th</span>');
        }
        html.push('<div class="main_diag_content">')
        if ($codeFirst.length > 0) {
          html.push('<div class="codeFirst">Code first<ul>');
          $codeFirst.each(function() {
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        if ($addCode.length > 0) {
          html.push('<div class="addCode">Use additionnal code<ul>');
          $addCode.each(function() {
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        if ($inclusion.length > 0) {
          html.push('<div class="inclusion">Inclusions<ul>');
          $inclusion.each(function() {
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        if ($exclusions1.length > 0) {
          html.push('<div class="exclusions1">Exclusions 1<ul>');
          $exclusions1.each(function() {
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        if ($exclusions2.length > 0) {
          html.push('<div class="exclusions2">Exclusions 2<ul>');
          $exclusions2.each(function() {
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        if ($sevenChrNote.length > 0) {
          html.push('<div class="sevenChrNote">Use 7th char<ul>');
          $sevenChrNote.each(function() {
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        if ($sevenChrDef.length > 0) {
          html.push('<div class="sevenChrDef"><ul>');
          $sevenChrDef.each(function() {
            html.push('<li><span class="code" code7="'+$(this).attr('char')+'">'+$(this).attr('char')+'</span> :<strong>'+$(this).text()+'</strong></li>');
          });
          html.push('</ul></div>');
        }
        if ($subdiag.length > 0) {
          html.push('<div class="subdiag"><ul>');
          $subdiag.each(function() {
            html.push('<li>'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span>');
            $specify = $(this).parent().children('diag').children('desc');
            $addCode_sub = $(this).parent().children('useAdditionalCode').children('note');
            $codeFirst_sub = $(this).parent().children('codeFirst').children('note');
            if ($codeFirst_sub.length >0) {
              html.push('<span class="badge badge-codeFirst">Code1st</span>');
            }
            if ($addCode_sub.length >0) {
              html.push('<span class="badge badge-addCode">Code+</span>');
            }
            if ($specify.length > 0) {
              html.push('<span class="badge badge-specify">Specify</span>');
            }
            $exclusions1_sub= $(this).parent().children('excludes1').children('note');
            if ($exclusions1_sub.length > 0) {
              html.push('<span class="badge badge-exclusions1">X1</span>');
            }
            $exclusions2_sub= $(this).parent().children('excludes2').children('note');
            if ($exclusions2_sub.length > 0) {
              html.push('<span class="badge badge-exclusions2">X2</span>');
            }
            $inclusion_sub= $(this).parent().children('inclusionTerm').children('note');
            if ($inclusion_sub.length > 0) {
              html.push('<span class="badge badge-inclusions">Inc</span>');
            }
            $sevenChrNote_sub = $(this).parent().children('sevenChrNote').children('note');
            $sevenChrDef_sub = $(this).parent().children('sevenChrDef').children('extension');
            if ($sevenChrNote_sub.length >0) {
              html.push('<span class="badge badge-sevenChrNote">7th</span>');
            }
            if ($codeFirst_sub.length > 0) {
              html.push('<div class="codeFirst">Code first<ul>');
              $codeFirst_sub.each(function() {
                html.push('<li>'+$(this).text()+'</li>');
              });
              html.push('</ul></div>');
            }
            if ($addCode_sub.length > 0) {
              html.push('<div class="addCode">Use additionnal code<ul>');
              $addCode_sub.each(function() {
                html.push('<li>'+$(this).text()+'</li>');
              });
              html.push('</ul></div>');
            }
            if ($exclusions1_sub.length > 0) {
              html.push('<div class="exclusions1"><ul>');
              $exclusions1_sub.each(function() {
                html.push('<li>'+$(this).text()+'</span></li>');
              });
              html.push('</ul></div>'); // div exclusions1_sub
            }
            if ($exclusions2_sub.length > 0) {
              html.push('<div class="exclusions2"><ul>');
              $exclusions2_sub.each(function() {
                html.push('<li>'+$(this).text()+'</span></li>');
              });
              html.push('</ul></div>'); // div exclusions2_sub
            }
            if ($inclusion_sub.length > 0) {
              html.push('<div class="inclusion"><ul>');
              $inclusion_sub.each(function() {
                html.push('<li>'+$(this).text()+'</span></li>');
              });
              html.push('</ul></div>'); // div inclusion_sub
            }
            if ($sevenChrNote_sub.length > 0) {
              html.push('<div class="sevenChrNote">Use 7th char<ul>');
              $sevenChrNote_sub.each(function() {
                html.push('<li>'+$(this).text()+'</li>');
              });
              html.push('</ul></div>');
            }
            if ($sevenChrDef_sub.length > 0) {
              html.push('<div class="sevenChrDef"><ul>');
              $sevenChrDef_sub.each(function() {
                html.push('<li><span class="code" code7="'+$(this).attr('char')+'">'+$(this).attr('char')+'</span> :<strong>'+$(this).text()+'</strong></li>');
              });
              html.push('</ul></div>');
            }
            if ($specify.length > 0) {
              html.push('<div class="specify"><ul>');
              $specify.each(function() {
                html.push('<li>'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span>');
                $specify2 = $(this).parent().children('diag').children('desc');
                $addCode_sub2 = $(this).parent().children('useAdditionalCode').children('note');
                $codeFirst_sub2 = $(this).parent().children('codeFirst').children('note');
                if ($codeFirst_sub2.length >0) {
                  html.push('<span class="badge badge-codeFirst">Code1st</span>');
                }
                if ($addCode_sub2.length >0) {
                  html.push('<span class="badge badge-addCode">Code+</span>');
                }
                if ($specify2.length > 0) {
                  html.push('<span class="badge badge-specify">Specify</span>');
                }
                $exclusions1_sub2= $(this).parent().children('excludes1').children('note');
                if ($exclusions1_sub2.length > 0) {
                  html.push('<span class="badge badge-exclusions1">X1</span>');
                }
                $exclusions2_sub2= $(this).parent().children('excludes2').children('note');
                if ($exclusions2_sub2.length > 0) {
                  html.push('<span class="badge badge-exclusions2">X2</span>');
                }
                $inclusion_sub2= $(this).parent().children('inclusionTerm').children('note');
                if ($inclusion_sub2.length > 0) {
                  html.push('<span class="badge badge-inclusions">Inc</span>');
                }
                $sevenChrNote_sub2 = $(this).parent().children('sevenChrNote').children('note');
                $sevenChrDef_sub2 = $(this).parent().children('sevenChrDef').children('extension');
                if ($sevenChrNote_sub2.length >0) {
                  html.push('<span class="badge badge-sevenChrNote">7th</span>');
                }
                if ($codeFirst_sub2.length > 0) {
                  html.push('<div class="codeFirst">Code first<ul>');
                  $codeFirst_sub.each(function() {
                    html.push('<li>'+$(this).text()+'</li>');
                  });
                  html.push('</ul></div>');
                }
                if ($addCode_sub2.length > 0) {
                  html.push('<div class="addCode">Use additionnal code<ul>');
                  $addCode_sub2.each(function() {
                    html.push('<li>'+$(this).text()+'</li>');
                  });
                  html.push('</ul></div>'); // addCode_sub2
                }
                if ($exclusions1_sub2.length > 0) {
                  html.push('<div class="exclusions1"><ul>');
                  $exclusions1_sub2.each(function() {
                    html.push('<li>'+$(this).text()+'</span></li>');
                  });
                  html.push('</ul></div>'); // div exclusions1_sub2
                }
                if ($exclusions2_sub2.length > 0) {
                  html.push('<div class="exclusions2"><ul>');
                  $exclusions2_sub.each(function() {
                    html.push('<li>'+$(this).text()+'</span></li>');
                  });
                  html.push('</ul></div>'); // div exclusions2_sub2
                }
                if ($inclusion_sub2.length > 0) {
                  html.push('<div class="inclusion"><ul>');
                  $inclusion_sub2.each(function() {
                    html.push('<li>'+$(this).text()+'</span></li>');
                  });
                  html.push('</ul></div>'); // div inclusion_sub2
                }
                if ($sevenChrNote_sub2.length > 0) {
                  html.push('<div class="sevenChrNote">Use 7th char<ul>');
                  $sevenChrNote_sub2.each(function() {
                    html.push('<li>'+$(this).text()+'</li>');
                  });
                  html.push('</ul></div>');
                }
                if ($sevenChrDef_sub2.length > 0) {
                  html.push('<div class="sevenChrDef"><ul>');
                  $sevenChrDef_sub2.each(function() {
                    html.push('<li><span class="code" code7="'+$(this).attr('char')+'">'+$(this).attr('char')+'</span> :<strong>'+$(this).text()+'</strong></li>');
                  });
                  html.push('</ul></div>');
                }
                if ($specify2.length > 0) {
                  html.push('<div class="specify2"><ul>');
                  $specify2.each(function() {
                    html.push('<li>'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span>');
                    $codeFirst_sub3 = $(this).parent().children('codeFirst').children('note');
                    if ($codeFirst_sub3.length >0) {
                      html.push('<span class="badge badge-codeFirst">Code1st</span>');
                    }
                    $addCode_sub3 = $(this).parent().children('useAdditionalCode').children('note');
                    if ($addCode_sub3.length >0) {
                      html.push('<span class="badge badge-addCode">Code+</span>');
                    }
                    $exclusions1_sub3= $(this).parent().children('excludes1').children('note');
                    if ($exclusions1_sub3.length > 0) {
                      html.push('<span class="badge badge-exclusions1">X1</span>');
                    }
                    $exclusions2_sub3= $(this).parent().children('excludes2').children('note');
                    if ($exclusions2_sub3.length > 0) {
                      html.push('<span class="badge badge-exclusions2">X2</span>');
                    }
                    $inclusion_sub3= $(this).parent().children('inclusionTerm').children('note');
                    if ($inclusion_sub3.length > 0) {
                      html.push('<span class="badge badge-inclusions">Inc</span>');
                    }
                    $sevenChrNote_sub3 = $(this).parent().children('sevenChrNote').children('note');
                    $sevenChrDef_sub3 = $(this).parent().children('sevenChrDef').children('extension');
                    if ($sevenChrNote_sub3.length >0) {
                      html.push('<span class="badge badge-sevenChrNote">7th</span>');
                    }
                    if ($codeFirst_sub3.length > 0) {
                      html.push('<div class="codeFirst">Code first<ul>');
                      $codeFirst_sub.each(function() {
                        html.push('<li>'+$(this).text()+'</li>');
                      });
                      html.push('</ul></div>');
                    }
                    if ($addCode_sub3.length > 0) {
                      html.push('<div class="addCode">Use additionnal code<ul>');
                      $addCode_sub3.each(function() {
                        html.push('<li>'+$(this).text()+'</li>');
                      });
                      html.push('</ul></div>'); // addCode_sub3
                    }
                    if ($exclusions1_sub3.length > 0) {
                      html.push('<div class="exclusions1"><ul>');
                      $exclusions1_sub3.each(function() {
                        html.push('<li>'+$(this).text()+'</span></li>');
                      });
                      html.push('</ul></div>'); // div exclusions1_sub3
                    }
                    if ($exclusions2_sub3.length > 0) {
                      html.push('<div class="exclusions1"><ul>');
                      $exclusions2_sub3.each(function() {
                        html.push('<li>'+$(this).text()+'</span></li>');
                      });
                      html.push('</ul></div>'); // div exclusions2_sub3
                    }
                    if ($inclusion_sub3.length > 0) {
                      html.push('<div class="inclusion"><ul>');
                      $inclusion_sub3.each(function() {
                        html.push('<li>'+$(this).text()+'</span></li>');
                      });
                      html.push('</ul></div>'); // div inclusion_sub3
                    }
                    if ($sevenChrNote_sub3.length > 0) {
                      html.push('<div class="sevenChrNote">Use 7th char<ul>');
                      $sevenChrNote_sub3.each(function() {
                        html.push('<li>'+$(this).text()+'</li>');
                      });
                      html.push('</ul></div>');
                    }
                    if ($sevenChrDef_sub3.length > 0) {
                      html.push('<div class="sevenChrDef"><ul>');
                      $sevenChrDef_sub3.each(function() {
                        html.push('<li><span class="code" code7="'+$(this).attr('char')+'">'+$(this).attr('char')+'</span> :<strong>'+$(this).text()+'</strong></li>');
                      });
                      html.push('</ul></div>');
                    }
                    html.push('</li>'); // li specify2
                  });
                  html.push('</ul>'); // ul specify2
                };
                html.push('</li>'); // li specify
              });
              html.push('</ul></div>'); // div specify
            }
            html.push('</li>') // li subdiag
          });
          html.push('</ul></div>'); // div subdiag
        }
        html.push('</li></div>'); // div main_diag_content
      });
      html.push('</ol>');
      var final_result = html.join('');
      var regex = /[A-Z]\d\d\.?[0-9X]?[0-9X]?[0-9X]?[A-Z]?/g;
      final_result = final_result.replace(regex,'<icd10>$&</icd10>');
      $('div#tabular').html(final_result);
      $('div.specify').hide();
      $('div.subdiag > ul > li > div.addCode').hide();
      $('div.subdiag > ul > li > div.codeFirst').hide();
      $('div.subdiag > ul > li > div.exclusions1').hide();
      $('div.subdiag > ul > li > div.exclusions2').hide();
      $('div.subdiag > ul > li > div.inclusion').hide();
      $('div.subdiag > ul > li > div.sevenChrNote').hide();
      $('div.subdiag > ul > li > div.sevenChrDef').hide();
      $('div.subdiag > ul > li').click(function(e){
        $(this).children('div.subdiag > ul > li > div.specify').toggle();
        $(this).children('div.subdiag > ul > li > div.addCode').toggle();
        $(this).children('div.subdiag > ul > li > div.codeFirst').toggle();
        $(this).children('div.subdiag > ul > li > div.exclusions1').toggle();
        $(this).children('div.subdiag > ul > li > div.exclusions2').toggle();
        $(this).children('div.subdiag > ul > li > div.inclusion').toggle();
        $(this).children('div.subdiag > ul > li > div.sevenChrNote').toggle();
        $(this).children('div.subdiag > ul > li > div.sevenChrDef').toggle();
         return false;
      });
      $('div.specify2').hide();
      $('div.specify > ul > li > div.addCode').hide();
      $('div.specify > ul > li > div.codeFirst').hide();
      $('div.specify > ul > li > div.exclusions1').hide();
      $('div.specify > ul > li > div.exclusions2').hide();
      $('div.specify > ul > li > div.inclusion').hide();
      $('div.specify > ul > li > div.sevenChrNote').hide();
      $('div.specify > ul > li > div.sevenChrDef').hide();
      $('div.specify > ul > li').click(function(e){
        $(this).children('div.specify > ul > li > div.specify2').toggle();
        $(this).children('div.specify > ul > li > div.addCode').toggle();
        $(this).children('div.specify > ul > li > div.codeFirst').toggle();
        $(this).children('div.specify > ul > li > div.exclusions1').toggle();
        $(this).children('div.specify > ul > li > div.exclusions2').toggle();
        $(this).children('div.specify > ul > li > div.inclusion').toggle();
        $(this).children('div.specify > ul > li > div.sevenChrNote').toggle();
        $(this).children('div.specify > ul > li > div.sevenChrDef').toggle();
         return false;
      });
      $('div.main_diag_content').hide();
      $('div.main_diag').click(function(){
        $(this).parent().children('div.main_diag_content').toggle();
        return false;
      });
      $('icd10').click(function(e){
        search_str= $(this).text();
        console.log(search_str);
        $('#icd10 input.desc').val(search_str);
        get_diag(search_str);
        e.stopPropagation();
      });
    },
    error: function () {
      console.log('error getting exams');
      }
  });
  }

$(function() {
    $("body").tooltip({ selector: '[data-toggle=tooltip]' });
}); // document ready

</script>

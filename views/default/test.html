{{extend 'layout.html'}}
{{block head}}
<style>
  .inclusion {
    background-color: Green;
    color: white;
    margin-left: 20px;
  }

  .badge {
    margin-left: 2px;
  }
  .badge-inclusions {
    background-color: Green;
    color: White;
  }

  .exclusions1 {
    background-color: Red;
    color: white;
    margin-left: 20px;
  }

  .badge-exclusions1 {
    background-color: Red;
    color: White;
  }

  .exclusions2 {
    background-color: Orange;
    color: white;
    margin-left: 20px;
  }

  .badge-exclusions2 {
    background-color: Orange;
    color: White;
  }

  .subdiag {
    background-color: LightBlue;
    color: black;
    margin-left: 20px;
  }
  .specify {
    background-color: Ivory;
    color: black;
    margin-left: 10px;
  }

  .code {
    background-color: Crimson;
    color: White;
  }

  ol {
    list-style-type: decimal;
  }
</style>
{{end}}

<div class="row">
  <div class="container">
    <div class="col-md-4">
      <form id="diag" class="" action="index.html" onsubmit="return false;">
        <div class="input-group">
          <input type="text" class="form-control desc" placeholder="icd-10 description"></input>
          <span class="input-group-btn"><button class="btn btn-primary submit" type="button">search</button></span>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row">
  <div class="container">
    <div class="col-md-4">
      <div class="test">
      </div>
    </div>
  </div>
</div>



<script type="text/javascript">

// var xmltest = '<?xml version="1.0" encoding="utf-8"?><diag><name>A60.00</name><desc>Herpesviral infection of urogenital system </desc><diag><name>002</name><desc>child</desc></diag></diag>',
//  xmlDoc = $.parseXML(xmltest),
//  $xml = $(xmlDoc),
//  $result = $xml.find('desc');
//  $result2 = $xml.children('diag').children('desc');
// $('div.test').append('find("desc"): '+$result.text()+'<br/>');
// $('div.test').append('children("desc"): '+$result2.text());

$('#diag .submit').click(function(e){
  e.preventDefault();
  search_str= $('#diag input.desc').val();
  console.log(search_str);
  get_diag(search_str);
})

function get_diag(search_str) {
  var API_URL = '{{=URL('api','icd10.xml', scheme=True, host=True)}}?search='+search_str;
  $.ajax({
    url: API_URL,
    type: 'GET',
    dataType: 'xml',
    contentType: 'application/xml',
    success: function (data) {
      html = ['<ol>'];
      $(data).children('main').children('diag').children('desc').each(function() {
        // console.log('desc: '+$(this).text());
        html.push('<li>'+'<div class="main_diag">'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span></div>');
        $subdiag = $(this).parent().children('diag').children('desc');
        if ($subdiag.length > 0) {
          html.push('<span class="badge badge-subdiag">Subdiag</span>');
        }
        $inclusion = $(this).parent().children('inclusionTerm').children('note');
        if ($inclusion.length >0) {
          html.push('<span class="badge badge-inclusions">Inclusions</span>');
        }
        $exclusions1 = $(this).parent().children('excludes1').children('note');
        if ($exclusions1.length >0) {
          html.push('<span class="badge badge-exclusions1">Exclusions 1</span>');
        }
        $exclusions2 = $(this).parent().children('excludes2').children('note');
        if ($exclusions2.length >0) {
          html.push('<span class="badge badge-exclusions2">Exclusions 2</span>');
        }
        html.push('<div class="main_diag_content">')
        // $inclusion = $(this).parent().children('inclusionTerm').children('note');
        if ($inclusion.length > 0) {
          html.push('<div class="inclusion">Inclusion<ul>');
          $inclusion.each(function() {
            // console.log($(this).text());
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        // $exclusions1 = $(this).parent().children('excludes1').children('note');
        if ($exclusions1.length > 0) {
          html.push('<div class="exclusions1">exclusions1<ul>');
          $exclusions1.each(function() {
            // console.log($(this).text());
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        // $exclusions2 = $(this).parent().children('excludes2').children('note');
        if ($exclusions2.length > 0) {
          html.push('<div class="exclusions2">exclusions2<ul>');
          $exclusions2.each(function() {
            // console.log($(this).text());
            html.push('<li>'+$(this).text()+'</li>');
          });
          html.push('</ul></div>');
        }
        // $subdiag = $(this).parent().children('diag').children('desc');
        if ($subdiag.length > 0) {
          // html.push('<button class="btn_subdiag">Subdiag</button><div class="subdiag"><ul>');
          html.push('<div class="subdiag"><ul>');
          $subdiag.each(function() {
            // console.log($(this).text());
            html.push('<li>'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span>');
            $specify = $(this).parent().children('diag').children('desc');
            if ($specify.length > 0) {
              console.log($(this).text());
              html.push('<span class="badge badge-specify">Specify</span><div class="specify"><ul>');
              $specify.each(function() {
                console.log($(this).text());
                html.push('<li>'+$(this).text()+' <span class="code">'+$(this).parent().children('name').text()+'</span></li>');
              });
              html.push('</ul></div>'); // div specify
            }
            html.push('</li>') // li subdiag
          });
          html.push('</ul></div>'); // div subdiag
        }
        html.push('</li></div>'); // div main_diag_content
      });
      html.push('</ol>');
      $('div.test').html(html.join(''));
      // $('div.subdiag').hide();
      $('div.specify').hide();
      $('div.subdiag > ul > li').click(function(){
        $(this).children('div.specify').toggle();
         return false;
      });
      //$('div.main_diag_content button').click(function(){
      //   $(this).parent().children('ul').toggle();
      //   return false;
      //});
      $('div.main_diag_content').hide();
      $('div.main_diag').click(function(){
        $(this).parent().children('div.main_diag_content').toggle();
        return false;
      });
    },
    error: function () {
      console.log('error getting exams');
      }
  });
  }

$(function() {
    $("body").tooltip({ selector: '[data-toggle=tooltip]' });
}); // document ready

</script>

{{extend 'layout.html'}}
{{block head}}
<script src="{{=URL('static','js/validator.js')}}"></script>
<script src="{{=URL('static','js/bootstrap-datepicker.js')}}"></script>
<link rel="stylesheet" href="{{=URL('static','css/bootstrap-datepicker3.css')}}" />

<style>
       .btn {
         margin: 2px ;
       }
       .edit_address {
       }
       .tooltip {
         font-size: 8px;
       }
</style>
{{end}}
{{block header}}
    <header class="container-fluid ">
      <div class="jumbotron text-center">
        <h2><span class="last_name"></span> <span class="first_name"></span></h2>
        <h3><strong><span class="dob_pid7"></span></strong></h3>
      </div>
    </header>
{{end}}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-4">
      <div class="panel panel-primary">
        <div class="panel-heading">
          <button type="button" class="btn btn-default btn-xs pull-right" id="edit_main" name="button">Edit</button>
          <h4 class="panel-title">Main details</h4> <span class="alert_main"></span>
        </div>
        <div class="panel-body">
          <ul class="list-group">
            <ul class="list-group">
              <li class="list-group-item"><strong>First Name:</strong> <span class="pull-right first_name"><span></li>
              <li class="list-group-item"><strong>Last Name:</strong> <span class="pull-right last_name"><span></li>
              <li class="list-group-item"><strong>Maiden name:</strong> <span class="pull-right maiden_name_pid6"><span></li>
              <li class="list-group-item"><strong>Gender:</strong> <span class="pull-right gender_pid8"><span></li>
              <li class="list-group-item"><strong>Date of birth:</strong> <span class="pull-right dob_pid7"><span></li>
              <li class="list-group-item"><strong>Email:</strong> <span class="pull-right email_user"></li>
              <li class="list-group-item"><strong>Town of birth:</strong> <span class="pull-right birth_town_pid23"><span></li>
              <li class="list-group-item"><strong>Country of birth:</strong> <span class="pull-right birth_country_pid23"><span></li>
              <li class="list-group-item"><strong>ID card number:</strong> <span class="pull-right idc_num"><span></li>
              <li class="list-group-item"><strong>Social security number:</strong> <span class="pull-right ssn_pid19"><span></li>
            </ul>
          </ul>
        </div>
        <div class="panel-footer">

        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="panel panel-info">
        <div class="panel-heading">
          <button type="button" class="btn btn-default btn-xs pull-right" name="button" id="new_address">New</button>
          <h4 class="panel-title">adresses</h4> <span class="alert_address"></span>
        </div>
        <div class="panel-body">
          <ol>
            <ul class="list-group" id="addresses_list">
            </ul>
          </ol>
        </div>
        <div class="panel-footer">

        </div>
      </div>

    </div>
  </div>
</div>



<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="edit_main_form" role="form" data-toggle="validator">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title .text-center" id="">File ID nÂ°<span class="user_id"></span></h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>First name:</label>
            <input type="text" class="form-control first_name" name="first_name" placeholder="First name" value="">
          </div>
          <div class="form-group">
            <label>Last name:</label>
            <input type="text" class="form-control last_name" name="last_name" placeholder="Last name">
          </div>
          <div class="form-group">
            <label>Maiden name</label>
            <input type="text" class="form-control" name="maiden_name" placeholder="Maiden name">
          </div>
          <div class="form-group">
            <label class="radio-inline"><input type="radio" name="gender" value="1">Male</label>
            <label class="radio-inline"><input type="radio" name="gender" value="2">Female</label>
            <label class="radio-inline"><input type="radio" name="gender" value="2">Undetermined</label>
          </div>
          <div class="form-group">
            <label>Date of birth:</label>
            <input type="text" class="form-control" name="dob" placeholder="dob">
          </div>
          <div class="form-group">
            <label for="inputEmail" class="control-label">Email:</label>
            <input type="email" class="form-control" name="email" placeholder="email" id="inputEmail" data-error="Email address is invalid" required>
          </div>
          <div class="form-group">
            <label>Town of birth:</label>
            <input type="text" class="form-control" name="birth_town" placeholder="Town of birth">
          </div>
          <div class="form-group">
            <label>Country of birth:</label>
            <input type="text" class="form-control" name="birth_country" placeholder="Country of birth">
          </div>
          <div class="form-group">
            <label>ID card number:</label>
            <input type="text" class="form-control" name="idc" placeholder="ID card number">
          </div>
          <div class="form-group">
            <label>Social security number:</label>
            <input type="text" class="form-control" name="ssn" placeholder="Social security number">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary submit">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
var user_id = {{=user_id}};
$(function () {
  var  $modal = $('#modal').modal({show: false}),
       $alert = $('.alert').hide();
  main_details(user_id);
  addresses_details(user_id);
  $("body").tooltip({ selector: '[data-toggle=tooltip]' });
  $('#edit_main').click(function () {
    $modal.modal('show');
   });

});

function fill_user(id,value, panel) {
  if (value == null) {
    value = 'n/a';
  } else if (id == '.gender_pid8') {
    if (value == 1) {
      value = 'Male';
    } else if (value == 2){
      value = 'Female';
    } else { value = 'Undetermined'};
  } else if ( id == '.dob_pid7') {
      value = reverseDate(value);
  }
  if (panel == 'details') {
    $(id).html(value);
  }
  else if (panel == 'form') {
    $(id).attr('value',value);
  } else {};
}

function reverseDate(dateStr) {
    var parts = dateStr.split("-");
    date_fr = parts.reverse();
    return date_fr.join('/');
}

function main_details(id) {
  var API_URL = '{{=URL('default','api_users/user', scheme=True, host=True)}}/';
  $.ajax({
    url: API_URL + id+'.json',
    type: 'GET',
    dataType: 'json',
    contentType: 'application/json',
    success: function (data) {
      user = data.content[0];
      fill_user('.user_id',user.id,'details');
      fill_user('.first_name',user.first_name,'details');
      fill_user('#edit_main_form .first_name',user.first_name,'form');
      fill_user('.last_name',user.last_name,'details');
      fill_user('#edit_main_form .lastname_name',user.last_name,'form');
      fill_user('.maiden_name_pid6',user.maiden_name_pid6,'details');
      fill_user('#edit_main_form .maiden_name_pid6_name',user.maiden_name_pid6,'form');
      fill_user('.gender_pid8',user.gender_pid8,'details');
      fill_user('#edit_main_form .gender_pid8',user.gender_pid8,'form');
      fill_user('.dob_pid7',user.dob_pid7,'details');
      fill_user('#edit_main_form .maiden_name_pid6_name',user.dob_pid7,'form');
      fill_user('.email_user',user.email,'details');
      fill_user('#edit_main_form .email',user.email,'form');
      fill_user('.birth_town_pid23',user.birth_town_pid23,'details');
      fill_user('.birth_country_pid23',user.birth_country_pid23,'details');
      fill_user('.idc_num',user.idc_num,'details');
      fill_user('.ssn_pid19',user.ssn_pid19,'details');
      },
    error: function () {
      alert('User not found!');
      }
  });
}

function addresses_details(id) {
    var API_URL = '{{=URL('default','api_users/address', scheme=True, host=True)}}/';
    $.ajax({
      url: API_URL + id+'.json',
      type: 'GET',
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        addresses = data.content;
        li_address(addresses);
        $('#addresses').text(addresses);
        },
      error: function () {
        alert('Address not found!');
        }
    });
}


function li_address (row) {
  var html = [];
  $.each(row, function (key, value) {
    html.push('<li id="li_'+key+'" class="list-group-item clearfix" data-toggle="tooltip" data-placement="top" data-createdby="'+test_null(row[key]['created_by'],'unknown')+ '" data-modifiedby="'+test_null(row[key]['modified_by'],'unknown')+ '" data-modifiedon="'+ test_null(row[key]['modified_on'],'unknown time')+'" title="">'); // tooltip
    html.push('<span>'+test_null(row[key]['home_num_pid11_1'],'')+' </span><span>'+ test_null(row[key]['box_num_pid11_2'],'') +' </span><span>'+ test_null(row[key]['address1_pid11_3'],'') + ' '+ test_null(row[key]['address2_pid11_4'],'') +'</span></br>');
    html.push('<span> '+ test_null(row[key]['zipcode_pid11_5'],'') + '</span><span> ' + test_null(row[key]['town_pid11_6'],'') + ' </span><span>' + test_null(row[key]['country_pid11_7'],'')+ '</span></li>');
    get_user_name(test_null(row[key]['created_by'],'0'),key,'data-createdby');
    get_user_name(test_null(row[key]['modified_by'],'0'),key,'data-modifiedby');
  });
  $('#addresses_list').html(html.join(''));
}

function test_null(value, ifnull) {
  if (value == null) {
    value = ifnull;
    return value;
  } else { return value; }
}

function get_user_name (index, id, attribute) {
  var API_URL = '{{=URL('default','api_users/user', scheme=True, host=True)}}/';
  if (index == 0) { $('li#li_'+id).attr(attribute,'unknown id');}
  else {
    $.ajax({
      url: API_URL+ index,
      type: 'GET',
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        if (attribute == 'data-createdby') {
          text = 'created by ';
        } else {
          text = 'modified by ';
        };
        $('li#li_'+id).attr(attribute,data.content[0].first_name + ' '+ data.content[0].last_name);
        $('li#li_'+id).attr('title', function(i,title) {
          return title + text +data.content[0].first_name + ' '+ data.content[0].last_name+' ';
        });
        test_mod = $('li#li_'+id).attr('title');
        if (test_mod.indexOf('modified') > -1) {
              $('li#li_'+id).attr('title', function(i,title) {
              return title+' '+$('li#li_'+id).attr('data-modifiedon');
            });
        };
        },
      error: function () {
        $('li#li_'+id).attr(attribute,'unknown get');
        }
    });
  }

}


</script>

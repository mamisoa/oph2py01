{{extend 'layout.html'}}
{{block head}}
<script src="{{=URL('static','js/validator.js')}}"></script>
<script src="{{=URL('static','js/bootstrap-datepicker.js')}}"></script>
<link rel="stylesheet" href="{{=URL('static','css/bootstrap-datepicker3.css')}}" />

<style>
       .btn {
         margin: 2px ;
       }
       .edit_address {
       }
       .tooltip {
         font-size: 8px;
       }
</style>
{{end}}
{{block header}}
    <header class="container-fluid ">
      <div class="jumbotron text-center">
        <h2><span class="last_name"></span> <span class="first_name"></span></h2>
        <h3><strong><span class="dob_pid7"></span></strong></h3>
      </div>
    </header>
{{end}}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-4">
      <div class="panel panel-primary">
        <div class="panel-heading">
          <button type="button" class="btn btn-default btn-xs pull-right" id="edit_main" name="button">Edit</button>
          <h4 class="panel-title">Main details<span class="alert_main"></h4> </span>
        </div>
        <div class="panel-body">
          <ul class="list-group">
            <ul class="list-group">
              <li class="list-group-item"><strong>First Name:</strong> <span class="pull-right first_name"><span></li>
              <li class="list-group-item"><strong>Last Name:</strong> <span class="pull-right last_name"><span></li>
              <li class="list-group-item"><strong>Maiden name:</strong> <span class="pull-right maiden_name_pid6"><span></li>
              <li class="list-group-item"><strong>Gender:</strong> <span class="pull-right gender_pid8"><span></li>
              <li class="list-group-item"><strong>Date of birth:</strong> <span class="pull-right dob_pid7"><span></li>
              <li class="list-group-item"><strong>Email:</strong> <span class="pull-right email_user"></li>
              <li class="list-group-item"><strong>Town of birth:</strong> <span class="pull-right birth_town_pid23"><span></li>
              <li class="list-group-item"><strong>Country of birth:</strong> <span class="pull-right birth_country_pid23"><span></li>
              <li class="list-group-item"><strong>ID card number:</strong> <span class="pull-right idc_num"><span></li>
              <li class="list-group-item"><strong>Social security number:</strong> <span class="pull-right ssn_pid19"><span></li>
            </ul>
          </ul>
        </div>
        <div class="panel-footer">

        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="panel panel-info">
        <div class="panel-heading">
          <button type="button" class="btn btn-default btn-xs pull-right" name="button" id="new_address">New</button>
          <h4 class="panel-title">adresses</h4> <span class="alert_address"></span>
        </div>
        <div class="panel-body">
          <ol>
            <ul class="list-group" id="addresses_list">
            </ul>
          </ol>
        </div>
        <div class="panel-footer">

        </div>
      </div>

    </div>
  </div>
</div>



<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="edit_main_form" role="form" data-toggle="validator">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title .text-center" id="">File ID nÂ°<span class="user_id"></span></h4>
        </div>
        <div class="modal-body">
          <div class="form-group hidden">
            <label>ID:</label>
            <input type="text" class="form-control user_id" name="id" placeholder="ID" value="">
          </div>
          <div class="form-group">
            <label>First name:</label>
            <input type="text" class="form-control first_name" name="first_name" placeholder="First name" value="">
          </div>
          <div class="form-group">
            <label>Last name:</label>
            <input type="text" class="form-control last_name" name="last_name" placeholder="Last name">
          </div>
          <div class="form-group">
            <label>Maiden name</label>
            <input type="text" class="form-control maiden_name_pid6" name="maiden_name_pid6" placeholder="Maiden name">
          </div>
          <div class="form-group">
            <label class="radio-inline"><input type="radio" name="gender_pid8" value="1">Male</label>
            <label class="radio-inline"><input type="radio" name="gender_pid8" value="2">Female</label>
            <label class="radio-inline"><input type="radio" name="gender_pid8" value="3">Undetermined</label>
          </div>
          <div class="form-group">
            <label>Date of birth:</label>
            <input type="text" class="form-control dob_pid7" name="dob_pid7" placeholder="dob">
          </div>
          <div class="form-group">
            <label for="inputEmail" class="control-label">Email:</label>
            <input type="email" class="form-control email_user" name="email" placeholder="email" id="inputEmail" data-error="Email address is invalid" required>
          </div>
          <div class="form-group">
            <label>Town of birth:</label>
            <input type="text" class="form-control birth_town_pid23" name="birth_town_pid23" placeholder="Town of birth">
          </div>
          <div class="form-group">
            <label>Country of birth:</label>
            <input type="text" class="form-control birth_country_pid23" name="birth_country_pid23" placeholder="Country of birth">
          </div>
          <div class="form-group">
            <label>ID card number:</label>
            <input type="text" class="form-control idc_num" name="idc_num" placeholder="ID card number">
          </div>
          <div class="form-group">
            <label>Social security number:</label>
            <input type="text" class="form-control ssn_pid19" name="ssn_pid19" placeholder="Social security number">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary submit">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
var user_id = {{=user_id}};
var API_URL = '{{=URL('default','api_users/user', scheme=True, host=True)}}/';
$(function () {
  var  $modal = $('#modal').modal({show: false}),
       $alert = $('.alert_main').hide();
  main_details(user_id);
  addresses_details(user_id);
  $("body").tooltip({ selector: '[data-toggle=tooltip]' });
  $('#edit_main').click(function () {
    $modal.modal('show');
   });
  $modal.find('.submit').click(function (e) {
      var row = {};
      e.preventDefault(); // on empeche l'envoi du formulaire par le navigateur
      $modal.find('input[name]').each(function () {
        row[$(this).attr('name')] = $(this).val();
      });
      row['gender_pid8'] = $('input:radio[name=gender_pid8]').filter(':checked').val();
      var API_URL = '{{=URL('default','api_users/auth_user', scheme=True, host=True)}}/';
      $.ajax({
        url: API_URL+user_id,
        type: 'put',
        contentType: 'application/json',
        data: JSON.stringify(row),
        success: function () {
          $modal.modal('hide');
          main_details(user_id);
          showAlert('Updated','success');
          },
          error: function () {
            $modal.modal('hide');
            showAlert('Updated item error!','danger');
          }
        });
  });

function showAlert(title, type) {
  $alert.attr('class', 'alert_main alert-' + type || 'success')
      .html('<i class="glyphicon glyphicon-check"></i> ' + title).show();
  setTimeout(function () {
    $alert.hide();
    }, 5000);
}

});

function fill_user(key_val, panel) {
  for (key in key_val) {
    if (key_val[key] == null) {
      key_val[key] = 'n/a';
    } else if (key == '.gender_pid8') {
      if (key_val[key] == 1) {
        key_val[key] = 'Male';
        $('input:radio[name=gender_pid8]').filter('[value=1]').prop('checked',true);
      } else if (key_val[key] == 2) {
        key_val[key] = 'Female';
        $('input:radio[name=gender_pid8]').filter('[value=2]').prop('checked',true);
      } else {
        key_val[key] = 'Undetermined';
        $('input:radio[name=gender_pid8]').filter('[value=3]').prop('checked',true);
      };
    } else if ( key == '.dob_pid7') {
        key_val[key] = reverseDate(key_val[key]);
    }
    if (panel == 'details') {
      $(key).html(key_val[key]);
    }
    else if (panel == 'form') {
      $(key).attr('value',key_val[key]);
    } else {};
  }
}




function reverseDate(dateStr) {
    var parts = dateStr.split("-");
    date_fr = parts.reverse();
    return date_fr.join('/');
}

function main_details(id) {
  $.ajax({
    url: API_URL + id+'.json',
    type: 'GET',
    dataType: 'json',
    contentType: 'application/json',
    success: function (data) {
      user = data.content[0];
      main_data = { '.user_id': user.id,'.first_name': user.first_name, '.last_name':user.last_name, '.maiden_name_pid6':user.maiden_name_pid6, '.gender_pid8': user.gender_pid8,
          '.dob_pid7': user.dob_pid7, '.email_user': user.email, '.birth_town_pid23': user.birth_town_pid23, '.birth_country_pid23': user.birth_country_pid23,
           '.idc_num':user.idc_num, '.ssn_pid19': user.ssn_pid19 }
      addresses_form = { '#edit_main_form .user_id': user.id, '#edit_main_form .first_name': user.first_name, '#edit_main_form .last_name': user.last_name, '#edit_main_form .maiden_name_pid6': user.maiden_name_pid6, '#edit_main_form .gender_pid8': user.gender_pid8,
        '#edit_main_form .dob_pid7': user.dob_pid7,  '#edit_main_form .email_user':user.email, '#edit_main_form .birth_town_pid23': user.birth_town_pid23, '#edit_main_form .birth_country_pid23': user.birth_country_pid23,
        '#edit_main_form .idc_num':user.idc_num, '#edit_main_form .ssn_pid19': user.ssn_pid19
           }
      fill_user(main_data,'details');
      fill_user(addresses_form,'form')
      },
    error: function () {
      alert('User not found!');
      }
  });
}


function addresses_details(id) {
    var API_URL = '{{=URL('default','api_users/address', scheme=True, host=True)}}/';
    $.ajax({
      url: API_URL + id+'.json',
      type: 'GET',
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        addresses = data.content;
        li_address(addresses);
        $('#addresses').text(addresses);
        },
      error: function () {
        alert('Address not found!');
        }
    });
}


function li_address (row) {
  var html = [];
  $.each(row, function (key, value) {
    html.push('<li id="li_'+key+'" class="list-group-item clearfix" data-toggle="tooltip" data-placement="top" data-createdby="'+test_null(row[key]['created_by'],'unknown')+ '" data-modifiedby="'+test_null(row[key]['modified_by'],'unknown')+ '" data-modifiedon="'+ test_null(row[key]['modified_on'],'unknown time')+'" title="">'); // tooltip
    html.push('<span>'+test_null(row[key]['home_num_pid11_1'],'')+' </span><span>'+ test_null(row[key]['box_num_pid11_2'],'') +' </span><span>'+ test_null(row[key]['address1_pid11_3'],'') + ' '+ test_null(row[key]['address2_pid11_4'],'') +'</span></br>');
    html.push('<span> '+ test_null(row[key]['zipcode_pid11_5'],'') + '</span><span> ' + test_null(row[key]['town_pid11_6'],'') + ' </span><span>' + test_null(row[key]['country_pid11_7'],'')+ '</span></li>');
    get_user_name(test_null(row[key]['created_by'],'0'),key,'data-createdby');
    get_user_name(test_null(row[key]['modified_by'],'0'),key,'data-modifiedby');
  });
  $('#addresses_list').html(html.join(''));
}

function test_null(value, ifnull) {
  if (value == null) {
    value = ifnull;
    return value;
  } else { return value; }
}

function get_user_name (index, id, attribute) {
  var API_URL = '{{=URL('default','api_users/user', scheme=True, host=True)}}/';
  if (index == 0) { $('li#li_'+id).attr(attribute,'unknown id');}
  else {
    $.ajax({
      url: API_URL+ index,
      type: 'GET',
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        if (attribute == 'data-createdby') {
          text = 'created by ';
        } else {
          text = 'modified by ';
        };
        $('li#li_'+id).attr(attribute,data.content[0].first_name + ' '+ data.content[0].last_name);
        $('li#li_'+id).attr('title', function(i,title) {
          return title + text +data.content[0].first_name + ' '+ data.content[0].last_name+' ';
        });
        test_mod = $('li#li_'+id).attr('title');
        if (test_mod.indexOf('modified') > -1) {
              $('li#li_'+id).attr('title', function(i,title) {
              return title+' '+$('li#li_'+id).attr('data-modifiedon');
            });
        };
        },
      error: function () {
        $('li#li_'+id).attr(attribute,'unknown get');
        }
    });
  }

}


</script>

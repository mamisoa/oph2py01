{{ from datetime import datetime
  patientname = db(db.auth_user.id == id_auth_user).select(db.auth_user.first_name, db.auth_user.last_name, db.auth_user.dob_pid7).first()
  patient = patientname.first_name + ' ' + patientname.last_name
  dob = patientname.dob_pid7
  worklistid = db(db.worklist.id == id_worklist).select(db.worklist.message_unique_id_MSH10, db.exam2do_OBR4.exam_description, db.worklist.requested_time_OBR6, db.worklist.status_flag, db.worklist.created_on,
    left=[db.exam2do_OBR4.on(db.exam2do_OBR4.id==db.worklist.exam2do_OBR4)]).first()
  exam = worklistid.exam2do_OBR4.exam_description
  timeslot = worklistid.worklist.requested_time_OBR6
  task = worklistid.worklist.message_unique_id_MSH10
  status = XML(worklistid.worklist.status_flag)
  createdOn = worklistid.worklist.created_on
  createdOnstr = createdOn.strftime('%Y-%m-%d %H:%M:%S')
  dateConsult = createdOn.strftime('%Y-%m-%d')
  dateFrom = createdOn.replace(hour=0,minute=0,second=0)
  dateTo = (dateFrom.replace(hour=23,minute=59,second=59)).strftime('%Y-%m-%d %H:%M:%S')
  dateFrom = dateFrom.strftime('%Y-%m-%d %H:%M:%S')
 }}
{{pass}}

{{extend 'layout.html'}}

{{block head}}
<!-- https://github.com/silviomoreto/bootstrap-select.git -->
<!-- bootstrap-table -->
<link rel="stylesheet" href="{{=URL('static','css/bootstrap-table.css')}}" />
<script src="{{=URL('static','js/bootstrap-table/bootstrap-table.js')}}"></script>
<script src="{{=URL('static','js/bootstrap-table/locales/bootstrap-table-fr-BE.min.js')}}"></script>
<script src="{{=URL('static','js/bootstrap-select/js/bootstrap-select.min.js')}}"></script>
<link rel="stylesheet" href="{{=URL('static','js/bootstrap-select/css/bootstrap-select.min.css')}}" />
<link rel="stylesheet" href="{{=URL('static','css/color_palette1.css')}}" />
<!-- https://github.com/datejs/Datejs -->
<script src="{{=URL('static','js/datejs/date.js')}}"></script>
<style>

  .btn-back {
    margin: 10px;
  }

  .btn-done {
    margin-top: 0px;
    margin-left: 5px;
    margin-bottom: 3px;
  }

  .task {
    margin-top: 20px;
    margin-bottom: 10px;
  }

  .col-centered {
      float: none;
      margin: 0 auto;
  }

  h3, h1 {
    text-align: center;
  }

  .consult_content {
    border:1px solid grey;
  }

.righteye {
  text-align: right;
  color: blue;
}

.lefteye {
  text-align: left;
  color: orange;
}

.botheyes {
  text-align: center;
}

.left_mes {
  text-align: right;
}

.right_mes {
  text-align: left;
}

.both_mes {
  text-align: center;
}


#objective {
   border: 1px solid grey;
}

#objective table, #objective table th  {
  text-align: center;
}
.badge-rx, .badge-tono, .badge-kerato, .badge-air, .badge-apla {
 margin-right: 3px;
 margin-left: 3px;
}

.badge-rx {
  background-color: #2f2d8e;
}

.badge-kerato {
  color: #2f2d8e;
  border: 1px solid #2f2d8e;
  background-color: transparent;
}

.badge-air {
  background-color: rgb(117, 195, 203);
}

.badge-apla {
  background-color: #2e09a8;
}

.rx_mes {
  border: 1px dotted grey;
  margin-top: 2px;
  margin-bottom: 2px;
}

.label-as-badge {
    border-radius: 1em;
}

</style>
{{end}}

<div class="container-fluid"> <!--header/title -->
  <div class="row"> <!--header -->
    <div class="col-sm-4">
      <a href="{{=URL('default','home', scheme=True, host=True )}}" class="btn btn-info btn-back" role="button">Back</a>
    </div>
    <div class="col-sm-4 patient">
        <h1>Patient <strong>{{=patient}}</strong> <small>{{=dob}}</small></h1>
    </div>
    <div class="col-sm-4">
      <div class="pull-right task">
        <span class="timeslot well">
          <span>Task planned for <em>{{=timeslot}}</em></span>
        </span>
        <span class="btn-done">
          <button type="button" class="btn-info btn"><span class="icon-done"></span><span class="text-done">Set to done</span></button>
        </span>
      </div> <!--task -->
    </div>
  </div> <!--header -->
  <div class="row"> <!-- title -->
    <div class="col-sm-12">
      <div class="well well-sm">
        <h3>{{=exam.upper()}} from {{=dateConsult}}</h3>
      </div>
    </div>
  </div>
</div> <!--header/title -->

<div class="container" id="objective">
  <div class="row" id="objective">
    <div class="col-md-4 left_mes">
      <div class="well well-sm">
        Left eye
      </div>
    </div>
    <div class="col-md-4 both_mes">
      <div class="well well-sm">
        Both eyes
      </div>
    </div>
    <div class="col-md-4 right_mes">
      <div class="well well-sm">
        Right eye
      </div>
    </div>
</div>

<div class="container">
  <div class="row" id="test">
  </div>
</div>

<script type="text/javascript">
var rows = [];
get_exams({{=id_auth_user}},'{{=dateFrom}}','{{=dateTo}}');

$(function() {
  $("body").tooltip({ selector: '[data-toggle=tooltip]' });
}); // get ready function

function get_exams(id,dateFrom,dateTo) {
  var API_URL = '{{=URL('api','consult', scheme=True, host=True)}}?id_auth_user='+id+'&dateFrom='+dateFrom+'&dateTo='+dateTo;
  $.ajax({
    url: API_URL,
    type: 'GET',
    dataType: 'json',
    contentType: 'application/json',
    success: function (data) {
      console.log(data);
      rows = data;
      for (i in rows) {
        for (exams in rows[i]) { // rows[0] = {tono: Array[4]}
          // console.log('rows['+i+']['+exams+']')
          // console.log(rows[i][exams]);
          for (x in rows[i][exams]) {
            console.log('rows['+i+']['+exams+']['+x+']');
            console.log(rows[i][exams][x]);
            if (exams == 'rx') {
              html = [];
              side = rows[i][exams][x]['rx']['laterality'][0];
              lat = ( side == 'right'? 'right':'left');
              contralat = (side == 'right'? 'left':'right');
              console.log(lat);
              createdOn= rows[i][exams][x]['rx']['created_on'];
              rx_origin = rows[i][exams][x]['rx']['rx_origin'][0];
              glass_type = rows[i][exams][x]['rx']['glass_type'][0];
              va_far = rows[i][exams][x]['rx']['va_far'];
              opto_far = rows[i][exams][x]['rx']['opto_far'];
              sph_far = round2dec(rows[i][exams][x]['rx']['sph_far']);
              cyl_far = round2dec(rows[i][exams][x]['rx']['cyl_far']);
              axis_far = rows[i][exams][x]['rx']['axis_far']+'°';
              va_int = rows[i][exams][x]['rx']['va_int'];
              opto_int = rows[i][exams][x]['rx']['opto_int'];
              sph_int = round2dec(rows[i][exams][x]['rx']['sph_int']);
              cyl_int = round2dec(rows[i][exams][x]['rx']['cyl_int']);
              axis_int = rows[i][exams][x]['rx']['axis_int']+'°';
              va_close = rows[i][exams][x]['rx']['va_close'];
              opto_close = rows[i][exams][x]['rx']['opto_close'];
              sph_close = round2dec(rows[i][exams][x]['rx']['sph_close']);
              cyl_close = round2dec(rows[i][exams][x]['rx']['cyl_close']);
              axis_close = rows[i][exams][x]['rx']['axis_close']+'°';
              html.push('<div data-toggle="tooltip" data-placement="'+side+'" title="'+createdOn+'" class="rx_mes">');
              if ((rx_origin == 'autorx')|(rx_origin == 'dil')|(rx_origin == 'cyclo')) {
                html.push('<div><span class="badge badge-rx pull-'+contralat+'">'+rx_origin+'</span></div>');
                html.push('<div>VA(<strong>far</strong>,'+opto_far+')=<strong>'+va_far+'</strong> with <strong>'+sph_far+'('+cyl_far+' x'+axis_far+')</strong></div>')
                html.push('</div>');
                html=html.join('');
                console.log(html);
                $('#objective .'+lat+'_mes').append(html);
              } else if (glass_type == 'monofocal') {
                html.push('<div><span class="badge badge-rx pull-'+contralat+'">'+rx_origin+' '+glass_type+'</span></div>');
                html.push('<div>VA(<strong>far</strong>,'+opto_far+')=<strong>'+va_far+'</strong> with <strong>'+sph_far+'('+cyl_far+' x'+axis_far+')</strong></div>')
                html.push('</div>');
                html=html.join('');
                $('#objective .'+lat+'_mes').append(html);
              } else if (glass_type == 'degressive') {
                html.push('<div><span class="badge badge-rx pull-'+contralat+'">'+rx_origin+' '+glass_type+'</span></div>');
                html.push('<div>VA(<strong>far</strong>,'+opto_far+')=<strong>'+va_far+'</strong> with <strong>'+sph_far+'('+cyl_far+' x'+axis_far+')</strong></div>')
                html.push('<div>VA(<strong>int</strong>,'+opto_int+')=<strong>'+va_int+'</strong> with <strong>'+sph_int+'('+cyl_int+' x'+axis_int+')</strong></div>');
                html.push('</div>');
                html=html.join('');
                $('#objective .'+lat+'_mes').append(html);
              } else {
                html.push('<div><span class="badge badge-rx ">'+rx_origin+' '+glass_type+'</span></div>');
                html.push('<table class="table table-condensed table-striped table-responsive"><thead><tr><th>Dist</th>')
                html.push('<th>VA</th><th>sph</th><th>cyl</th><th>axis</th><th>opto</th></tr></thead>')
                html.push('<tbody><tr><td>Far</td><td>'+va_far+'</td><td>'+sph_far+'</td><td>'+cyl_far+'</td><td>'+axis_far+'</td><td>'+opto_far+'</td></tr>')
                html.push('<tr><td>Int</td><td>'+va_int+'</td><td>'+sph_int+'</td><td>'+cyl_int+'</td><td>'+axis_int+'</td><td>'+opto_int+'</td></tr>')
                html.push('<tr><td>Close</td><td>'+va_close+'</td><td>'+sph_close+'</td><td>'+cyl_close+'</td><td>'+axis_close+'</td><td>'+opto_close+'</td></tr></tbody></table>')
                html.push('</div>');
                html=html.join('');
                $('#objective .'+lat+'_mes').append(html);
              };
            } else if (exams =='topo') {
              side = rows[i][exams][x]['topography']['laterality'][0];
              lat = ( side == 'right'? 'right':'left');
              contralat = (side == 'right'? 'left':'right');
              console.log(lat);
              createdOn = rows[i][exams][x]['topography']['created_on'];
              k1 = rows[i][exams][x]['topography']['k1']+'mm@';
              k2 = rows[i][exams][x]['topography']['k2']+'mm@';
              axis1 = rows[i][exams][x]['topography']['axis1']+'°';
              axis2 = rows[i][exams][x]['topography']['axis2']+'°';
              $('#objective .'+lat+'_mes').append('<div data-toggle="tooltip" data-placement="'+side+'" title="'+createdOn+'" class="'
                 +'"><span class="badge badge-kerato pull-'+contralat+'">kerato</span> <strong>K1='+k1+axis1
                  +' K2='+k2+axis2+'<strong></div>');
            } else if (exams =='tono') {
              side = rows[i][exams][x]['tono']['laterality'][0];
              lat = (side == 'right'? 'right':'left');
              contralat = (side == 'right'? 'left':'right');
              console.log(lat);
              tio = rows[i][exams][x]['tono']['tonometry']+'mmHg';
              techno = rows[i][exams][x]['tono']['techno'][0];
              createdOn = ' @ '+(Date.parse(rows[i][exams][x]['tono']['created_on'])).toString('HH:mm');
              html =[];
              $('#objective .'+lat+'_mes').append('<div class="'+'"><span class="badge badge-tono pull-'+contralat+'">TIO</span><span class="badge badge-'
               +techno+' pull-'+contralat+'">'+techno+'</span><strong>'+tio+'</strong>'+createdOn+'</div>');
            };
            // for (m in rows[i][exams][x]) {
            //console.log('rows['+i+']['+exams+']['+x+']'+'['+m+']');
            //console.log(rows[i][exams][x][m]);
            //$('.consult_content').append('<li>'+rows[i][exams][x][m]+'</li>');
            // }
          };
        };
      };
    },
    error: function () {
      console.log('error getting exams');
      }
  });
  }

  function round2dec(num) {
    num = Math.round(num*100)/100;
    num = num.toFixed(2);
    num >0? num='+'+num : {};
    return num;
  }

</script>
